<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emason Hub</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">
            <img src="images/logo.png" alt="Emason Hub Logo">
        </div>
        <nav>
            <ul>
                <li><a href="#home">HOME</a></li>
                <li><a href="#catalog">SHOP BY CATEGORY</a></li>
                <li>
                    <button class="cart-button" onclick="location.href='#cart'">
                        <img src="images/cart.png" alt="Cart">
                        CART (<span id="cart-count">0</span>)
                    </button>
                </li>
            </ul>
        </nav>
    </header>
    
    <section id="home" class="hero">
        <img src="images/imageTOP.jpg" alt="Curtains Display">
        <div class="hero-text">
            <h1>EMASON HUB</h1>
            <p>Bring home interiors at your doorstep</p>
            <button onclick="location.href='#catalog'">SHOP NOW</button>
        </div>
    </section>

    <section id="catalog" class="catalog">
        <h2 class="section-title">Shop by Category</h2>
        <div class="categories">
            <button onclick="showCategory('curtains')">Curtains</button>
            <button onclick="showCategory('wallpapers')">Wallpapers</button>
            <button onclick="showCategory('windowblinds')">Window Blinds</button>
        </div>
    </section>

    <div id="products-container"></div>

    <section id="cart" class="cart">
        <h2 class="section-title">Your Cart</h2>
        <div id="cart-items"></div>
        <button class="place-order-button" onclick="goToCheckout()">CHECK OUT</button>
    </section>
    
    <section class="testimonials">
        <h2>Testimonials</h2>
        <div class="testimonial">
            <p>"Emason Hub has transformed my living room with their beautiful curtains. The quality is top-notch and the service was excellent. Highly recommend!"</p>
            <p>- Chinedu Okafor</p>
        </div>
        <div class="testimonial">
            <p>"I am extremely satisfied with the wallpapers I purchased from Emason Hub. They have a wide variety of designs and the installation was seamless. Great job!"</p>
            <p>- Aisha Bello</p>
        </div>
        <div class="testimonial">
            <p>"The window blinds I got from Emason Hub are perfect. They add a touch of elegance to my office. The customer service was also very helpful and responsive."</p>
            <p>- Tunde Adeyemi</p>
        </div>
        <img src="images/logo.png" alt="Emason Hub Logo" class="testimonials-img">
    </section>

    <footer>
        <p>Contact us: <a href="mailto:emasonhub@gmail.com">info@emasonhub.com</a></p>
        <p>Follow us on Instagram: <a href="https://www.instagram.com/emason_curtainhub?igsh=MTJrZm9xMjEzcWV2Nw==" target="_blank" rel="noopener">@emasonhub</a></p>
        <p>&copy; 2025. All Rights Reserved.</p>
    </footer>

    <button class="back-to-top" onclick="scrollToTop()">↑</button>

    <script type="module">
        import config from './src/config.js';

        const backendUrl = config.backendUrl;
        const cart = [];
        let productsData = {};

        function updatePrice(sizeId, quantityId, priceId, productId) {
            const size = document.getElementById(sizeId).value;
            const quantity = document.getElementById(quantityId).value;
            const pricePerUnit = productsData[productId].sizes[size];
            const totalPrice = pricePerUnit * quantity;
            document.getElementById(priceId).innerText = `₦${totalPrice}`;
        }

        function changeQuantity(quantityId, delta) {
            const quantityInput = document.getElementById(quantityId);
            let quantity = parseInt(quantityInput.value);
            quantity = Math.max(1, Math.min(9, quantity + delta));
            quantityInput.value = quantity;
            const sizeId = quantityId.replace('quantity', 'size');
            const priceId = quantityId.replace('quantity', 'price');
            const productId = quantityId.replace('quantity', 'product');
            updatePrice(sizeId, quantityId, priceId, productId);
        }

        function addToCart(name, color, sizeId, quantityId, priceId) {
            const size = document.getElementById(sizeId).value;
            const quantity = document.getElementById(quantityId).value;
            const price = document.getElementById(priceId).innerText;
            cart.push({ name, color, size, quantity, price });
            updateCartCount();
            displayCartItems();
        }

        function updateCartCount() {
            document.getElementById('cart-count').innerText = cart.length;
        }

        function displayCartItems() {
            const cartItems = document.getElementById('cart-items');
            cartItems.innerHTML = '';
            cart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <p>${item.name} - ${item.color} - ${item.size} - Quantity: ${item.quantity} - ${item.price}</p>
                    <button onclick="removeFromCart(${index})">REMOVE</button>
                `;
                cartItems.appendChild(itemDiv);
            });
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartCount();
            displayCartItems();
        }

        async function placeOrder() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            const shippingDetails = {
                name: 'John Doe',
                address: '123 Main St',
                city: 'Lagos',
                state: 'Lagos',
                zip: '100001',
                country: 'Nigeria',
                email: 'johndoe@example.com'
            };

            const billingDetails = {
                name: 'John Doe',
                address: '123 Main St',
                city: 'Lagos',
                state: 'Lagos',
                zip: '100001',
                country: 'Nigeria'
            };

            const orderDetails = {
                items: cart,
                shippingDetails,
                billingDetails,
                amount: cart.reduce((total, item) => total + parseFloat(item.price.replace('₦', '')), 0),
                email: shippingDetails.email
            };

            try {
                console.log('Sending order details:', orderDetails); // Log the order details being sent
                const response = await fetch(`${backendUrl}/payments/create-payment-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderDetails)
                });

                const data = await response.json();
                console.log('Payment intent response:', data); // Log the response
                if (data.authorization_url) {
                    window.location.href = data.authorization_url;
                } else {
                    alert('Failed to create payment intent');
                    console.error('Payment intent creation failed:', data); // Log the error details
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create payment intent');
            }
        }

        async function verifyPayment(reference) {
            try {
                const response = await fetch(`${backendUrl}/payments/verify-payment?reference=${reference}`);
                const data = await response.json();
                if (data.status === 'success') {
                    window.location.href = `/order-confirmation.html?orderId=${reference}`;
                } else {
                    window.location.href = `/order-confirmation.html?orderId=${reference}&status=failed`;
                }
            } catch (error) {
                console.error('Error verifying payment:', error);
                window.location.href = `/order-confirmation.html?orderId=${reference}&status=failed`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const reference = urlParams.get('reference');
            if (reference) {
                verifyPayment(reference);
            }
            loadProducts();
        });

        async function loadProducts() {
            try {
                const response = await fetch(`${backendUrl}/admin/products`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                productsData = await response.json();
                console.log('Loaded products:', productsData); // Log the loaded products

                // Display products in the catalog section
                const container = document.getElementById('products-container');
                container.innerHTML = ''; // Clear any existing content

                Object.keys(productsData).forEach(categoryId => {
                    const section = document.createElement('section');
                    section.id = categoryId;
                    section.className = 'products';
                    section.innerHTML = `<h3 class="section-subtitle">${categoryId.charAt(0).toUpperCase() + categoryId.slice(1)}</h3>`;

                    productsData[categoryId].forEach((product, index) => {
                        const productDiv = document.createElement('div');
                        productDiv.className = 'product';
                        productDiv.innerHTML = `
                            <img src="${product.image}" alt="${product.name}">
                            <div class="product-details">
                                <h3>${product.name}</h3>
                                <p>Color - ${product.color}</p>
                                <p>
                                    <label for="size${categoryId}${index}">Size:</label>
                                    <select id="size${categoryId}${index}" name="size${categoryId}${index}" onchange="updatePrice('size${categoryId}${index}', 'quantity${categoryId}${index}', 'price${categoryId}${index}', '${categoryId}${index}')">
                                        ${Object.keys(product.sizes).map(size => `<option value="${size}">${size.charAt(0).toUpperCase() + size.slice(1)}</option>`).join('')}
                                    </select>
                                </p>
                                <p>
                                    <label for="quantity${categoryId}${index}">Quantity:</label>
                                    <div class="quantity-controls">
                                        <button type="button" onclick="changeQuantity('quantity${categoryId}${index}', -1)">-</button>
                                        <input type="number" id="quantity${categoryId}${index}" name="quantity${categoryId}${index}" value="1" min="1" max="9" readonly>
                                        <button type="button" onclick="changeQuantity('quantity${categoryId}${index}', 1)">+</button>
                                    </div>
                                </p>
                                <p>Price: <span id="price${categoryId}${index}">₦${product.sizes.small}</span></p>
                                <button onclick="addToCart('${product.name}', '${product.color}', 'size${categoryId}${index}', 'quantity${categoryId}${index}', 'price${categoryId}${index}')">ADD TO CART</button>
                            </div>
                        `;
                        section.appendChild(productDiv);
                    });

                    container.appendChild(section);
                });
            } catch (error) {
                console.error('Failed to load products:', error);
            }
        }

        function showCategory(categoryId) {
            const container = document.getElementById('products-container');
            container.innerHTML = ''; // Clear any existing content

            if (!productsData[categoryId]) {
                console.error(`Category '${categoryId}' not found.`);
                return;
            }

            const section = document.createElement('section');
            section.id = categoryId;
            section.className = 'products';
            section.innerHTML = `<h3 class="section-subtitle">${categoryId.charAt(0).toUpperCase() + categoryId.slice(1)}</h3>`;

            productsData[categoryId].forEach((product, index) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product';
                productDiv.innerHTML = `
                    <img src="${product.image}" alt="${product.name}">
                    <div class="product-details">
                        <h3>${product.name}</h3>
                        <p>Color - ${product.color}</p>
                        <p>
                            <label for="size${categoryId}${index}">Size:</label>
                            <select id="size${categoryId}${index}" name="size${categoryId}${index}" onchange="updatePrice('size${categoryId}${index}', 'quantity${categoryId}${index}', 'price${categoryId}${index}', '${categoryId}${index}')">
                                ${Object.keys(product.sizes).map(size => `<option value="${size}">${size.charAt(0).toUpperCase() + size.slice(1)}</option>`).join('')}
                            </select>
                        </p>
                        <p>
                            <label for="quantity${categoryId}${index}">Quantity:</label>
                            <div class="quantity-controls">
                                <button type="button" onclick="changeQuantity('quantity${categoryId}${index}', -1)">-</button>
                                <input type="number" id="quantity${categoryId}${index}" name="quantity${categoryId}${index}" value="1" min="1" max="9" readonly>
                                <button type="button" onclick="changeQuantity('quantity${categoryId}${index}', 1)">+</button>
                            </div>
                        </p>
                        <p>Price: <span id="price${categoryId}${index}">₦${product.sizes.small}</span></p>
                        <button onclick="addToCart('${product.name}', '${product.color}', 'size${categoryId}${index}', 'quantity${categoryId}${index}', 'price${categoryId}${index}')">ADD TO CART</button>
                    </div>
                `;
                section.appendChild(productDiv);
            });

            container.appendChild(section);
            section.scrollIntoView({ behavior: 'smooth' });
        }

        window.onscroll = function() {
            const backToTopButton = document.querySelector('.back-to-top');
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                backToTopButton.style.display = 'block';
            } else {
                backToTopButton.style.display = 'none';
            }
        };

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToCheckout() {
            localStorage.setItem('cart', JSON.stringify(cart));
            window.location.href = 'checkout.html';
        }
    </script>
</body>
</html>
